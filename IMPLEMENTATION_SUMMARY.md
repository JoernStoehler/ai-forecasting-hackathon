# Materials Pipeline Implementation Summary

## Overview

This PR implements a complete pipeline for downloading external sources (URLs), converting them to markdown snapshots, and using them as materials with provenance tracking via HTML comments.

## What Was Built

### 1. Snapshot Download Command (`packages/cli/src/commands/downloadSnapshots.ts`)

A new CLI command that:
- Takes a `sources.json` file as input (array of `{id, url, tags?}`)
- Downloads HTML from each URL
- Cleans it (removes script/style tags)
- Converts to markdown using Turndown
- Adds metadata header as HTML comment
- Saves to `{id}.md` files
- Supports incremental updates (skips existing files unless `--force`)

**Usage:**
```bash
node packages/cli/dist/src/index.js download-snapshots \
  --sources packages/engine/src/data/snapshots/sources.json \
  --output packages/engine/src/data/snapshots
```

### 2. HTML Comment Stripping (`packages/engine/src/utils/materials.ts`)

Two utility functions exported from the engine:
- `stripHtmlComments(text: string)`: Removes all `<!-- ... -->` comments
- `stripCommentsFromMaterials<T>(materials: T[])`: Strips comments from material bodies

Integrated into `preparePrompt()` so LLMs never see provenance comments.

### 3. Provenance Convention

HTML comments can be used anywhere in materials for citation:

**Metadata Header (auto-generated by download script):**
```markdown
<!-- SNAPSHOT METADATA
  id: source-id
  url: https://example.com
  accessedAt: 2024-01-01T00:00:00.000Z
  tags: ai-safety, governance
-->
```

**Inline Citations (manual, freeform):**
```markdown
Recent research shows... <!-- Source: Kaplan et al. 2020 -->
Safety concerns exist <!-- See: https://example.com/article -->
```

### 4. Directory Structure

```
packages/engine/src/data/snapshots/
├── README.md              # Complete documentation
├── sources.json           # Production URL list (empty initially)
├── sources.example.json   # Example format
├── .gitignore            # Ignore *.md.tmp during development
└── *.md                  # Downloaded snapshots
```

### 5. Testing

**Unit Tests (9 tests in `materials.test.ts`):**
- Single/multiple HTML comment removal
- Multi-line comments
- Empty strings
- Metadata header removal
- Materials array processing

**Integration Tests (2 tests in `materials-provenance.test.ts`):**
- Full snapshot workflow with metadata
- Materials with inline provenance

**Demo Scripts:**
- `test-download.js`: Manual download testing
- `demo-provenance.js`: Shows comment stripping end-to-end

### 6. Documentation

**Main README** (`packages/engine/src/data/snapshots/README.md`):
- Provenance conventions explained
- Download command usage
- Sources file format
- Examples of using snapshots in materials
- Testing information

## How It Works

### Content Pipeline Flow

```
Internet URL
  ↓ (download-snapshots command)
HTML content
  ↓ (clean: remove scripts/styles)
Cleaned HTML
  ↓ (Turndown conversion)
Markdown with metadata header
  ↓ (saved as .md file)
Local snapshot
  ↓ (loaded into MATERIALS)
Material with provenance comments
  ↓ (preparePrompt with stripComments)
Clean prompt for LLM
```

### Key Design Decisions

1. **Location**: `packages/engine/src/data/snapshots/` keeps everything engine-owned (as confirmed by project owner)

2. **Freeform Comments**: No enforced citation syntax - use whatever makes sense for your material

3. **Automatic Stripping**: `preparePrompt()` automatically strips comments, so you never accidentally send them to LLMs

4. **Incremental Updates**: Default behavior preserves existing snapshots unless `--force` is used

5. **Minimal Dependencies**: Only added `turndown` for HTML→markdown conversion

## Testing the Implementation

### Run Tests
```bash
npm test -w packages/engine  # 17 tests pass
```

### Try the Demo
```bash
node packages/cli/demo-provenance.js
```

Shows:
- Raw snapshot with comments
- Cleaned content (LLM view)
- Statistics on comment removal
- Verification that no comments remain

### Download a Snapshot (requires network access)

1. Edit `packages/engine/src/data/snapshots/sources.json`:
```json
[
  {
    "id": "my-article",
    "url": "https://example.com/article",
    "tags": ["ai-safety"]
  }
]
```

2. Run download:
```bash
npm run build -w packages/cli
node packages/cli/dist/src/index.js download-snapshots \
  --sources packages/engine/src/data/snapshots/sources.json \
  --output packages/engine/src/data/snapshots
```

3. Check result:
```bash
cat packages/engine/src/data/snapshots/my-article.md
```

## Integration with Existing Code

### Before This PR

Materials were inline TypeScript strings in `materials.ts`:

```typescript
export const MATERIALS: MaterialDoc[] = [
  {
    id: 'expert-model',
    title: 'Expert Model',
    body: `# Expert Model\n\nContent here...`,
  },
];
```

### After This PR

You can now:

**Option 1: Keep inline materials, add provenance comments**
```typescript
export const MATERIALS: MaterialDoc[] = [
  {
    id: 'expert-model',
    title: 'Expert Model',
    body: `# Expert Model

<!-- Sources:
  - https://example.com/article
  - Kaplan et al. 2020
-->

Content here...`,
  },
];
```

**Option 2: Load from snapshots** (requires async or top-level await)
```typescript
// Snapshots available in packages/engine/src/data/snapshots/*.md
// Load them however makes sense for your workflow
```

### Backward Compatibility

✅ **100% backward compatible**
- Existing materials without comments work exactly as before
- `preparePrompt()` just passes through text without comments
- No breaking changes to any APIs

## What's Next (Future Work)

These are NOT part of this PR but could be done later:

1. **Post-game Reports**: Re-include citation comments and turn them into clickable links for player post-mortems

2. **Better HTML Cleaning**: Consider using a more robust HTML sanitizer if needed (current approach is simple but effective)

3. **Snapshot Updates**: Add CLI flag to re-download snapshots older than X days

4. **Citation Parsing**: If structured citations become useful, add optional parser (but keep freeform as default)

5. **Non-`src/` Location**: Could move snapshots out of `src/` into a top-level data folder if desired

## Files Changed

### New Files (10)
- `packages/cli/src/commands/downloadSnapshots.ts` - Download command
- `packages/cli/test-download.js` - Manual test script
- `packages/cli/demo-provenance.js` - Demo script
- `packages/engine/src/utils/materials.ts` - Comment stripping utilities
- `packages/engine/src/data/snapshots/README.md` - Documentation
- `packages/engine/src/data/snapshots/sources.json` - Production URL list
- `packages/engine/src/data/snapshots/sources.example.json` - Example
- `packages/engine/src/data/snapshots/.gitignore` - Ignore tmp files
- `packages/engine/test/materials.test.ts` - Unit tests
- `packages/engine/test/materials-provenance.test.ts` - Integration tests

### Modified Files (4)
- `packages/cli/src/index.ts` - Added download-snapshots command
- `packages/cli/package.json` - Added turndown dependency
- `packages/engine/src/index.ts` - Export utilities, integrate stripping
- `package-lock.json` - Updated dependencies

### Example File (1)
- `packages/engine/src/data/snapshots/example-ai-safety-article.md` - Shows provenance in action

## Verification Checklist

- ✅ All tests pass (17 tests)
- ✅ Linting passes
- ✅ Type checking passes
- ✅ Build succeeds
- ✅ Demo script works
- ✅ Example snapshot included
- ✅ Documentation complete
- ✅ Code review feedback addressed
- ✅ Backward compatible
- ✅ No breaking changes

## Questions or Issues?

If something is unclear or you'd like changes, let me know! The implementation is minimal and focused on the core requirements, so it should be easy to adjust if needed.
